{"ast":null,"code":"'use strict';\n\nexports.__esModule = true;\nexports.logIn = logIn;\nexports.signUp = signUp;\nexports.signUpError = signUpError;\nexports.resetPassword = resetPassword;\nexports.showLoginActivity = showLoginActivity;\nexports.showSignUpActivity = showSignUpActivity;\nexports.showResetPasswordActivity = showResetPasswordActivity;\nexports.cancelResetPassword = cancelResetPassword;\nexports.cancelMFALogin = cancelMFALogin;\nexports.toggleTermsAcceptance = toggleTermsAcceptance;\nexports.showLoginMFAActivity = showLoginMFAActivity;\nexports.swapCaptcha = swapCaptcha;\n\nvar _immutable = require('immutable');\n\nvar _immutable2 = _interopRequireDefault(_immutable);\n\nvar _index = require('../../store/index');\n\nvar _web_api = require('../../core/web_api');\n\nvar _web_api2 = _interopRequireDefault(_web_api);\n\nvar _actions = require('../../core/actions');\n\nvar _index2 = require('../../core/index');\n\nvar l = _interopRequireWildcard(_index2);\n\nvar _index3 = require('../../field/index');\n\nvar c = _interopRequireWildcard(_index3);\n\nvar _index4 = require('./index');\n\nvar _i18n = require('../../i18n');\n\nvar i18n = _interopRequireWildcard(_i18n);\n\nfunction _interopRequireWildcard(obj) {\n  if (obj && obj.__esModule) {\n    return obj;\n  } else {\n    var newObj = {};\n\n    if (obj != null) {\n      for (var key in obj) {\n        if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key];\n      }\n    }\n\n    newObj.default = obj;\n    return newObj;\n  }\n}\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nfunction logIn(id) {\n  var needsMFA = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n  var m = (0, _index.read)(_index.getEntity, 'lock', id);\n  var usernameField = (0, _index4.databaseLogInWithEmail)(m) ? 'email' : 'username';\n  var username = c.getFieldValue(m, usernameField);\n  var params = {\n    connection: (0, _index4.databaseConnectionName)(m),\n    username: username,\n    password: c.getFieldValue(m, 'password')\n  };\n  var fields = [usernameField, 'password'];\n  var isCaptchaValid = setCaptchaParams(m, params, fields);\n\n  if (!isCaptchaValid) {\n    return showMissingCaptcha(m, id);\n  }\n\n  var mfaCode = c.getFieldValue(m, 'mfa_code');\n\n  if (needsMFA) {\n    params['mfa_code'] = mfaCode;\n    fields.push('mfa_code');\n  }\n\n  (0, _actions.logIn)(id, fields, params, function (id, error, fields, next) {\n    if (error.error === 'a0.mfa_required') {\n      return showLoginMFAActivity(id);\n    }\n\n    if (error) {\n      var wasInvalid = error && error.code === 'invalid_captcha';\n      return swapCaptcha(id, wasInvalid, next);\n    }\n\n    next();\n  });\n}\n\nfunction generateRandomUsername(length) {\n  var result = '';\n  var characters = 'abcdefghijklmnopqrstuvwxyz0123456789';\n  var charactersLength = characters.length;\n\n  for (var i = 0; i < length; i++) {\n    result += characters.charAt(Math.floor(Math.random() * charactersLength));\n  }\n\n  return result;\n}\n\nfunction signUp(id) {\n  var m = (0, _index.read)(_index.getEntity, 'lock', id);\n  var fields = ['email', 'password']; // Skip the username validation if signUpHideUsernameField option is enabled.\n  // We will generate a random username to avoid name collusion before we make the signup API call.\n\n  if ((0, _index4.databaseConnectionRequiresUsername)(m) && !(0, _index4.signUpHideUsernameField)(m)) fields.push('username');\n  (0, _index4.additionalSignUpFields)(m).forEach(function (x) {\n    return fields.push(x.get('name'));\n  });\n  (0, _actions.validateAndSubmit)(id, fields, function (m) {\n    var params = {\n      connection: (0, _index4.databaseConnectionName)(m),\n      email: c.getFieldValue(m, 'email'),\n      password: c.getFieldValue(m, 'password'),\n      autoLogin: (0, _index4.shouldAutoLogin)(m)\n    };\n    var isCaptchaValid = setCaptchaParams(m, params, fields);\n\n    if (!isCaptchaValid) {\n      return showMissingCaptcha(m, id);\n    }\n\n    if ((0, _index4.databaseConnectionRequiresUsername)(m)) {\n      if ((0, _index4.signUpHideUsernameField)(m)) {\n        var usernameValidation = (0, _index4.databaseConnection)(m).getIn(['validation', 'username']);\n        var range = usernameValidation ? usernameValidation.toJS() : {\n          max: 15\n        };\n        params.username = generateRandomUsername(range.max);\n      } else {\n        params.username = c.getFieldValue(m, 'username');\n      }\n    }\n\n    if (!(0, _index4.additionalSignUpFields)(m).isEmpty()) {\n      params.user_metadata = {};\n      (0, _index4.additionalSignUpFields)(m).forEach(function (x) {\n        var storage = x.get('storage');\n        var fieldName = x.get('name');\n        var fieldValue = c.getFieldValue(m, x.get('name'));\n\n        switch (storage) {\n          case 'root':\n            params[fieldName] = fieldValue;\n            break;\n\n          default:\n            if (!params.user_metadata) {\n              params.user_metadata = {};\n            }\n\n            params.user_metadata[fieldName] = fieldValue;\n            break;\n        }\n      });\n    }\n\n    _web_api2.default.signUp(id, params, function (error, result, popupHandler) {\n      for (var _len = arguments.length, args = Array(_len > 3 ? _len - 3 : 0), _key = 3; _key < _len; _key++) {\n        args[_key - 3] = arguments[_key];\n      }\n\n      if (error) {\n        if (!!popupHandler) {\n          popupHandler._current_popup.kill();\n        }\n\n        var wasInvalidCaptcha = error && error.code === 'invalid_captcha';\n        swapCaptcha(id, wasInvalidCaptcha, function () {\n          setTimeout(function () {\n            return signUpError(id, error);\n          }, 250);\n        });\n      } else {\n        signUpSuccess.apply(undefined, [id, result, popupHandler].concat(args));\n      }\n    });\n  });\n}\n\nfunction signUpSuccess(id, result, popupHandler) {\n  var lock = (0, _index.read)(_index.getEntity, 'lock', id);\n  l.emitEvent(lock, 'signup success', result);\n\n  if ((0, _index4.shouldAutoLogin)(lock)) {\n    (0, _index.swap)(_index.updateEntity, 'lock', id, function (m) {\n      return m.set('signedUp', true);\n    }); // TODO: check options, redirect is missing\n\n    var options = {\n      connection: (0, _index4.databaseConnectionName)(lock),\n      username: c.email(lock),\n      password: c.password(lock)\n    };\n\n    if (!!popupHandler) {\n      options.popupHandler = popupHandler;\n    }\n\n    return _web_api2.default.logIn(id, options, l.auth.params(lock).toJS(), function (error) {\n      for (var _len2 = arguments.length, args = Array(_len2 > 1 ? _len2 - 1 : 0), _key2 = 1; _key2 < _len2; _key2++) {\n        args[_key2 - 1] = arguments[_key2];\n      }\n\n      if (error) {\n        setTimeout(function () {\n          return autoLogInError(id, error);\n        }, 250);\n      } else {\n        _actions.logInSuccess.apply(undefined, [id].concat(args));\n      }\n    });\n  }\n\n  var autoclose = l.ui.autoclose(lock);\n\n  if (!autoclose) {\n    (0, _index.swap)(_index.updateEntity, 'lock', id, function (lock) {\n      return l.setSubmitting(lock, false).set('signedUp', true);\n    });\n  } else {\n    (0, _actions.closeLock)(id, false);\n  }\n}\n\nfunction signUpError(id, error) {\n  var m = (0, _index.read)(_index.getEntity, 'lock', id);\n  var invalidPasswordKeys = {\n    PasswordDictionaryError: 'password_dictionary_error',\n    PasswordNoUserInfoError: 'password_no_user_info_error',\n    PasswordStrengthError: 'password_strength_error'\n  };\n  var errorKey = error.code === 'invalid_password' && invalidPasswordKeys[error.name] || error.code;\n  var errorMessage = i18n.html(m, ['error', 'signUp', errorKey]) || i18n.html(m, ['error', 'signUp', 'lock.fallback']);\n  l.emitEvent(m, 'signup error', error);\n\n  if (errorKey === 'invalid_captcha') {\n    errorMessage = i18n.html(m, ['error', 'login', errorKey]);\n    return swapCaptcha(id, true, function () {\n      (0, _index.swap)(_index.updateEntity, 'lock', id, l.setSubmitting, false, errorMessage);\n    });\n  }\n\n  (0, _index.swap)(_index.updateEntity, 'lock', id, l.setSubmitting, false, errorMessage);\n}\n\nfunction autoLogInError(id, error) {\n  (0, _index.swap)(_index.updateEntity, 'lock', id, function (m) {\n    var errorMessage = l.loginErrorMessage(m, error);\n\n    if ((0, _index4.hasScreen)(m, 'login')) {\n      return l.setSubmitting((0, _index4.setScreen)(m, 'login'), false, errorMessage);\n    } else {\n      return l.setSubmitting(m, false, errorMessage);\n    }\n  });\n}\n\nfunction resetPassword(id) {\n  (0, _actions.validateAndSubmit)(id, ['email'], function (m) {\n    var params = {\n      connection: (0, _index4.databaseConnectionName)(m),\n      email: c.getFieldValue(m, 'email')\n    };\n\n    _web_api2.default.resetPassword(id, params, function (error) {\n      if (error) {\n        setTimeout(function () {\n          return resetPasswordError(id, error);\n        }, 250);\n      } else {\n        resetPasswordSuccess(id);\n      }\n    });\n  });\n}\n\nfunction resetPasswordSuccess(id) {\n  var m = (0, _index.read)(_index.getEntity, 'lock', id);\n\n  if ((0, _index4.hasScreen)(m, 'login')) {\n    (0, _index.swap)(_index.updateEntity, 'lock', id, function (m) {\n      return (0, _index4.setScreen)(l.setSubmitting(m, false), 'login', ['']);\n    } // array with one empty string tells the function to not clear any field\n    ); // TODO: should be handled by box\n\n    setTimeout(function () {\n      var successMessage = i18n.html(m, ['success', 'forgotPassword']);\n      (0, _index.swap)(_index.updateEntity, 'lock', id, l.setGlobalSuccess, successMessage);\n    }, 500);\n  } else {\n    if (l.ui.autoclose(m)) {\n      (0, _actions.closeLock)(id);\n    } else {\n      (0, _index.swap)(_index.updateEntity, 'lock', id, function (m) {\n        return l.setSubmitting(m, false).set('passwordResetted', true);\n      });\n    }\n  }\n}\n\nfunction resetPasswordError(id, error) {\n  var m = (0, _index.read)(_index.getEntity, 'lock', id);\n  var errorMessage = i18n.html(m, ['error', 'forgotPassword', error.code]) || i18n.html(m, ['error', 'forgotPassword', 'lock.fallback']);\n  (0, _index.swap)(_index.updateEntity, 'lock', id, l.setSubmitting, false, errorMessage);\n}\n\nfunction showLoginActivity(id) {\n  var fields = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : ['password'];\n  (0, _index.swap)(_index.updateEntity, 'lock', id, _index4.setScreen, 'login', fields);\n}\n\nfunction showSignUpActivity(id) {\n  var fields = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : ['password'];\n  (0, _index.swap)(_index.updateEntity, 'lock', id, _index4.setScreen, 'signUp', fields);\n}\n\nfunction showResetPasswordActivity(id) {\n  var fields = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : ['password'];\n  (0, _index.swap)(_index.updateEntity, 'lock', id, _index4.setScreen, 'forgotPassword', fields);\n}\n\nfunction cancelResetPassword(id) {\n  return showLoginActivity(id);\n}\n\nfunction cancelMFALogin(id) {\n  return showLoginActivity(id);\n}\n\nfunction toggleTermsAcceptance(id) {\n  (0, _index.swap)(_index.updateEntity, 'lock', id, _index4.toggleTermsAcceptance);\n}\n\nfunction showLoginMFAActivity(id) {\n  var fields = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : ['mfa_code'];\n  (0, _index.swap)(_index.updateEntity, 'lock', id, _index4.setScreen, 'mfaLogin', fields);\n}\n/**\n * Get a new challenge and display the new captcha image.\n *\n * @param {number} id The id of the Lock instance.\n * @param {boolean} wasInvalid A boolean indicating if the previous captcha was invalid.\n * @param {Function} [next] A callback.\n */\n\n\nfunction swapCaptcha(id, wasInvalid, next) {\n  return _web_api2.default.getChallenge(id, function (err, newCaptcha) {\n    if (!err && newCaptcha) {\n      (0, _index.swap)(_index.updateEntity, 'lock', id, l.setCaptcha, newCaptcha, wasInvalid);\n    }\n\n    if (next) {\n      next();\n    }\n  });\n}\n/**\n * Display the error message of missing captcha in the header of lock.\n *\n * @param {Object} m model\n * @param {Number} id\n */\n\n\nfunction showMissingCaptcha(m, id) {\n  var captchaConfig = l.captcha(m);\n  var captchaError = captchaConfig.get('provider') === 'recaptcha_v2' ? 'invalid_recaptcha' : 'invalid_captcha';\n  var errorMessage = i18n.html(m, ['error', 'login', captchaError]);\n  (0, _index.swap)(_index.updateEntity, 'lock', id, function (m) {\n    m = l.setSubmitting(m, false, errorMessage);\n    return c.showInvalidField(m, 'captcha');\n  });\n  return m;\n}\n/**\n * Set the captcha value in the fields object before sending the request.\n *\n * @param {Object} m model\n * @param {Object} params\n * @param {Object} fields\n *\n * @returns {Boolean} returns true if is required and missing the response from the user\n */\n\n\nfunction setCaptchaParams(m, params, fields) {\n  var captchaConfig = l.captcha(m);\n  var isCaptchaRequired = captchaConfig && l.captcha(m).get('required');\n\n  if (!isCaptchaRequired) {\n    return true;\n  }\n\n  var captcha = c.getFieldValue(m, 'captcha'); //captcha required and missing\n\n  if (!captcha) {\n    return false;\n  }\n\n  params['captcha'] = captcha;\n  fields.push('captcha');\n  return true;\n}","map":{"version":3,"sources":["/Users/mozcan/Desktop/UK/gasbroker-front-end/node_modules/auth0-lock/lib/connection/database/actions.js"],"names":["exports","__esModule","logIn","signUp","signUpError","resetPassword","showLoginActivity","showSignUpActivity","showResetPasswordActivity","cancelResetPassword","cancelMFALogin","toggleTermsAcceptance","showLoginMFAActivity","swapCaptcha","_immutable","require","_immutable2","_interopRequireDefault","_index","_web_api","_web_api2","_actions","_index2","l","_interopRequireWildcard","_index3","c","_index4","_i18n","i18n","obj","newObj","key","Object","prototype","hasOwnProperty","call","default","id","needsMFA","arguments","length","undefined","m","read","getEntity","usernameField","databaseLogInWithEmail","username","getFieldValue","params","connection","databaseConnectionName","password","fields","isCaptchaValid","setCaptchaParams","showMissingCaptcha","mfaCode","push","error","next","wasInvalid","code","generateRandomUsername","result","characters","charactersLength","i","charAt","Math","floor","random","databaseConnectionRequiresUsername","signUpHideUsernameField","additionalSignUpFields","forEach","x","get","validateAndSubmit","email","autoLogin","shouldAutoLogin","usernameValidation","databaseConnection","getIn","range","toJS","max","isEmpty","user_metadata","storage","fieldName","fieldValue","popupHandler","_len","args","Array","_key","_current_popup","kill","wasInvalidCaptcha","setTimeout","signUpSuccess","apply","concat","lock","emitEvent","swap","updateEntity","set","options","auth","_len2","_key2","autoLogInError","logInSuccess","autoclose","ui","setSubmitting","closeLock","invalidPasswordKeys","PasswordDictionaryError","PasswordNoUserInfoError","PasswordStrengthError","errorKey","name","errorMessage","html","loginErrorMessage","hasScreen","setScreen","resetPasswordError","resetPasswordSuccess","successMessage","setGlobalSuccess","getChallenge","err","newCaptcha","setCaptcha","captchaConfig","captcha","captchaError","showInvalidField","isCaptchaRequired"],"mappings":"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","sourcesContent":["'use strict';\n\nexports.__esModule = true;\nexports.logIn = logIn;\nexports.signUp = signUp;\nexports.signUpError = signUpError;\nexports.resetPassword = resetPassword;\nexports.showLoginActivity = showLoginActivity;\nexports.showSignUpActivity = showSignUpActivity;\nexports.showResetPasswordActivity = showResetPasswordActivity;\nexports.cancelResetPassword = cancelResetPassword;\nexports.cancelMFALogin = cancelMFALogin;\nexports.toggleTermsAcceptance = toggleTermsAcceptance;\nexports.showLoginMFAActivity = showLoginMFAActivity;\nexports.swapCaptcha = swapCaptcha;\n\nvar _immutable = require('immutable');\n\nvar _immutable2 = _interopRequireDefault(_immutable);\n\nvar _index = require('../../store/index');\n\nvar _web_api = require('../../core/web_api');\n\nvar _web_api2 = _interopRequireDefault(_web_api);\n\nvar _actions = require('../../core/actions');\n\nvar _index2 = require('../../core/index');\n\nvar l = _interopRequireWildcard(_index2);\n\nvar _index3 = require('../../field/index');\n\nvar c = _interopRequireWildcard(_index3);\n\nvar _index4 = require('./index');\n\nvar _i18n = require('../../i18n');\n\nvar i18n = _interopRequireWildcard(_i18n);\n\nfunction _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction logIn(id) {\n  var needsMFA = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n\n  var m = (0, _index.read)(_index.getEntity, 'lock', id);\n  var usernameField = (0, _index4.databaseLogInWithEmail)(m) ? 'email' : 'username';\n  var username = c.getFieldValue(m, usernameField);\n  var params = {\n    connection: (0, _index4.databaseConnectionName)(m),\n    username: username,\n    password: c.getFieldValue(m, 'password')\n  };\n\n  var fields = [usernameField, 'password'];\n\n  var isCaptchaValid = setCaptchaParams(m, params, fields);\n  if (!isCaptchaValid) {\n    return showMissingCaptcha(m, id);\n  }\n\n  var mfaCode = c.getFieldValue(m, 'mfa_code');\n  if (needsMFA) {\n    params['mfa_code'] = mfaCode;\n    fields.push('mfa_code');\n  }\n\n  (0, _actions.logIn)(id, fields, params, function (id, error, fields, next) {\n    if (error.error === 'a0.mfa_required') {\n      return showLoginMFAActivity(id);\n    }\n\n    if (error) {\n      var wasInvalid = error && error.code === 'invalid_captcha';\n      return swapCaptcha(id, wasInvalid, next);\n    }\n\n    next();\n  });\n}\n\nfunction generateRandomUsername(length) {\n  var result = '';\n  var characters = 'abcdefghijklmnopqrstuvwxyz0123456789';\n  var charactersLength = characters.length;\n  for (var i = 0; i < length; i++) {\n    result += characters.charAt(Math.floor(Math.random() * charactersLength));\n  }\n  return result;\n}\n\nfunction signUp(id) {\n  var m = (0, _index.read)(_index.getEntity, 'lock', id);\n  var fields = ['email', 'password'];\n\n  // Skip the username validation if signUpHideUsernameField option is enabled.\n  // We will generate a random username to avoid name collusion before we make the signup API call.\n  if ((0, _index4.databaseConnectionRequiresUsername)(m) && !(0, _index4.signUpHideUsernameField)(m)) fields.push('username');\n\n  (0, _index4.additionalSignUpFields)(m).forEach(function (x) {\n    return fields.push(x.get('name'));\n  });\n\n  (0, _actions.validateAndSubmit)(id, fields, function (m) {\n    var params = {\n      connection: (0, _index4.databaseConnectionName)(m),\n      email: c.getFieldValue(m, 'email'),\n      password: c.getFieldValue(m, 'password'),\n      autoLogin: (0, _index4.shouldAutoLogin)(m)\n    };\n\n    var isCaptchaValid = setCaptchaParams(m, params, fields);\n    if (!isCaptchaValid) {\n      return showMissingCaptcha(m, id);\n    }\n\n    if ((0, _index4.databaseConnectionRequiresUsername)(m)) {\n      if ((0, _index4.signUpHideUsernameField)(m)) {\n        var usernameValidation = (0, _index4.databaseConnection)(m).getIn(['validation', 'username']);\n        var range = usernameValidation ? usernameValidation.toJS() : { max: 15 };\n        params.username = generateRandomUsername(range.max);\n      } else {\n        params.username = c.getFieldValue(m, 'username');\n      }\n    }\n\n    if (!(0, _index4.additionalSignUpFields)(m).isEmpty()) {\n      params.user_metadata = {};\n      (0, _index4.additionalSignUpFields)(m).forEach(function (x) {\n        var storage = x.get('storage');\n        var fieldName = x.get('name');\n        var fieldValue = c.getFieldValue(m, x.get('name'));\n        switch (storage) {\n          case 'root':\n            params[fieldName] = fieldValue;\n            break;\n          default:\n            if (!params.user_metadata) {\n              params.user_metadata = {};\n            }\n            params.user_metadata[fieldName] = fieldValue;\n            break;\n        }\n      });\n    }\n\n    _web_api2.default.signUp(id, params, function (error, result, popupHandler) {\n      for (var _len = arguments.length, args = Array(_len > 3 ? _len - 3 : 0), _key = 3; _key < _len; _key++) {\n        args[_key - 3] = arguments[_key];\n      }\n\n      if (error) {\n        if (!!popupHandler) {\n          popupHandler._current_popup.kill();\n        }\n        var wasInvalidCaptcha = error && error.code === 'invalid_captcha';\n        swapCaptcha(id, wasInvalidCaptcha, function () {\n          setTimeout(function () {\n            return signUpError(id, error);\n          }, 250);\n        });\n      } else {\n        signUpSuccess.apply(undefined, [id, result, popupHandler].concat(args));\n      }\n    });\n  });\n}\n\nfunction signUpSuccess(id, result, popupHandler) {\n  var lock = (0, _index.read)(_index.getEntity, 'lock', id);\n\n  l.emitEvent(lock, 'signup success', result);\n\n  if ((0, _index4.shouldAutoLogin)(lock)) {\n    (0, _index.swap)(_index.updateEntity, 'lock', id, function (m) {\n      return m.set('signedUp', true);\n    });\n\n    // TODO: check options, redirect is missing\n    var options = {\n      connection: (0, _index4.databaseConnectionName)(lock),\n      username: c.email(lock),\n      password: c.password(lock)\n    };\n\n    if (!!popupHandler) {\n      options.popupHandler = popupHandler;\n    }\n\n    return _web_api2.default.logIn(id, options, l.auth.params(lock).toJS(), function (error) {\n      for (var _len2 = arguments.length, args = Array(_len2 > 1 ? _len2 - 1 : 0), _key2 = 1; _key2 < _len2; _key2++) {\n        args[_key2 - 1] = arguments[_key2];\n      }\n\n      if (error) {\n        setTimeout(function () {\n          return autoLogInError(id, error);\n        }, 250);\n      } else {\n        _actions.logInSuccess.apply(undefined, [id].concat(args));\n      }\n    });\n  }\n\n  var autoclose = l.ui.autoclose(lock);\n\n  if (!autoclose) {\n    (0, _index.swap)(_index.updateEntity, 'lock', id, function (lock) {\n      return l.setSubmitting(lock, false).set('signedUp', true);\n    });\n  } else {\n    (0, _actions.closeLock)(id, false);\n  }\n}\n\nfunction signUpError(id, error) {\n  var m = (0, _index.read)(_index.getEntity, 'lock', id);\n\n  var invalidPasswordKeys = {\n    PasswordDictionaryError: 'password_dictionary_error',\n    PasswordNoUserInfoError: 'password_no_user_info_error',\n    PasswordStrengthError: 'password_strength_error'\n  };\n\n  var errorKey = error.code === 'invalid_password' && invalidPasswordKeys[error.name] || error.code;\n\n  var errorMessage = i18n.html(m, ['error', 'signUp', errorKey]) || i18n.html(m, ['error', 'signUp', 'lock.fallback']);\n\n  l.emitEvent(m, 'signup error', error);\n\n  if (errorKey === 'invalid_captcha') {\n    errorMessage = i18n.html(m, ['error', 'login', errorKey]);\n    return swapCaptcha(id, true, function () {\n      (0, _index.swap)(_index.updateEntity, 'lock', id, l.setSubmitting, false, errorMessage);\n    });\n  }\n\n  (0, _index.swap)(_index.updateEntity, 'lock', id, l.setSubmitting, false, errorMessage);\n}\n\nfunction autoLogInError(id, error) {\n  (0, _index.swap)(_index.updateEntity, 'lock', id, function (m) {\n    var errorMessage = l.loginErrorMessage(m, error);\n    if ((0, _index4.hasScreen)(m, 'login')) {\n      return l.setSubmitting((0, _index4.setScreen)(m, 'login'), false, errorMessage);\n    } else {\n      return l.setSubmitting(m, false, errorMessage);\n    }\n  });\n}\n\nfunction resetPassword(id) {\n  (0, _actions.validateAndSubmit)(id, ['email'], function (m) {\n    var params = {\n      connection: (0, _index4.databaseConnectionName)(m),\n      email: c.getFieldValue(m, 'email')\n    };\n\n    _web_api2.default.resetPassword(id, params, function (error) {\n      if (error) {\n        setTimeout(function () {\n          return resetPasswordError(id, error);\n        }, 250);\n      } else {\n        resetPasswordSuccess(id);\n      }\n    });\n  });\n}\n\nfunction resetPasswordSuccess(id) {\n  var m = (0, _index.read)(_index.getEntity, 'lock', id);\n  if ((0, _index4.hasScreen)(m, 'login')) {\n    (0, _index.swap)(_index.updateEntity, 'lock', id, function (m) {\n      return (0, _index4.setScreen)(l.setSubmitting(m, false), 'login', ['']);\n    } // array with one empty string tells the function to not clear any field\n    );\n\n    // TODO: should be handled by box\n    setTimeout(function () {\n      var successMessage = i18n.html(m, ['success', 'forgotPassword']);\n      (0, _index.swap)(_index.updateEntity, 'lock', id, l.setGlobalSuccess, successMessage);\n    }, 500);\n  } else {\n    if (l.ui.autoclose(m)) {\n      (0, _actions.closeLock)(id);\n    } else {\n      (0, _index.swap)(_index.updateEntity, 'lock', id, function (m) {\n        return l.setSubmitting(m, false).set('passwordResetted', true);\n      });\n    }\n  }\n}\n\nfunction resetPasswordError(id, error) {\n  var m = (0, _index.read)(_index.getEntity, 'lock', id);\n\n  var errorMessage = i18n.html(m, ['error', 'forgotPassword', error.code]) || i18n.html(m, ['error', 'forgotPassword', 'lock.fallback']);\n\n  (0, _index.swap)(_index.updateEntity, 'lock', id, l.setSubmitting, false, errorMessage);\n}\n\nfunction showLoginActivity(id) {\n  var fields = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : ['password'];\n\n  (0, _index.swap)(_index.updateEntity, 'lock', id, _index4.setScreen, 'login', fields);\n}\n\nfunction showSignUpActivity(id) {\n  var fields = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : ['password'];\n\n  (0, _index.swap)(_index.updateEntity, 'lock', id, _index4.setScreen, 'signUp', fields);\n}\n\nfunction showResetPasswordActivity(id) {\n  var fields = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : ['password'];\n\n  (0, _index.swap)(_index.updateEntity, 'lock', id, _index4.setScreen, 'forgotPassword', fields);\n}\n\nfunction cancelResetPassword(id) {\n  return showLoginActivity(id);\n}\n\nfunction cancelMFALogin(id) {\n  return showLoginActivity(id);\n}\n\nfunction toggleTermsAcceptance(id) {\n  (0, _index.swap)(_index.updateEntity, 'lock', id, _index4.toggleTermsAcceptance);\n}\n\nfunction showLoginMFAActivity(id) {\n  var fields = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : ['mfa_code'];\n\n  (0, _index.swap)(_index.updateEntity, 'lock', id, _index4.setScreen, 'mfaLogin', fields);\n}\n\n/**\n * Get a new challenge and display the new captcha image.\n *\n * @param {number} id The id of the Lock instance.\n * @param {boolean} wasInvalid A boolean indicating if the previous captcha was invalid.\n * @param {Function} [next] A callback.\n */\nfunction swapCaptcha(id, wasInvalid, next) {\n  return _web_api2.default.getChallenge(id, function (err, newCaptcha) {\n    if (!err && newCaptcha) {\n      (0, _index.swap)(_index.updateEntity, 'lock', id, l.setCaptcha, newCaptcha, wasInvalid);\n    }\n    if (next) {\n      next();\n    }\n  });\n}\n\n/**\n * Display the error message of missing captcha in the header of lock.\n *\n * @param {Object} m model\n * @param {Number} id\n */\nfunction showMissingCaptcha(m, id) {\n  var captchaConfig = l.captcha(m);\n  var captchaError = captchaConfig.get('provider') === 'recaptcha_v2' ? 'invalid_recaptcha' : 'invalid_captcha';\n  var errorMessage = i18n.html(m, ['error', 'login', captchaError]);\n  (0, _index.swap)(_index.updateEntity, 'lock', id, function (m) {\n    m = l.setSubmitting(m, false, errorMessage);\n    return c.showInvalidField(m, 'captcha');\n  });\n  return m;\n}\n\n/**\n * Set the captcha value in the fields object before sending the request.\n *\n * @param {Object} m model\n * @param {Object} params\n * @param {Object} fields\n *\n * @returns {Boolean} returns true if is required and missing the response from the user\n */\nfunction setCaptchaParams(m, params, fields) {\n  var captchaConfig = l.captcha(m);\n  var isCaptchaRequired = captchaConfig && l.captcha(m).get('required');\n  if (!isCaptchaRequired) {\n    return true;\n  }\n  var captcha = c.getFieldValue(m, 'captcha');\n  //captcha required and missing\n  if (!captcha) {\n    return false;\n  }\n\n  params['captcha'] = captcha;\n  fields.push('captcha');\n  return true;\n}\n"]},"metadata":{},"sourceType":"script"}